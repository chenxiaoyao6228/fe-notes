## 前言

本文总结DNS(域名系统)解析相关的知识点，大纲如下：

- DNS的由来
- DNS 解析的过程
- nodejs实现DNS解析
- 四类自定义域名的解析过程

## DNS由来

### IP 的记忆问题

在本地开发的时候，我们会通过webpack或者vite等开发工具启动一个本地服务，然后通过浏览器访问ip来访问这个服务。

而在互联网发展的早期，当还没有域名系统（DNS）之前，人们主要通过使用 IP 地址直接访问网络资源。这意味着用户必须知道目标服务器的确切 IP 地址，难度很大。

### host文件

为了解决IP的记忆问题，人们想到了一个办法，就是在本地维护一个host文件，这个文件中包含了域名和IP的映射关系，这样我们就可以通过域名来访问网络资源了.

> www.google.com ->  xxx
> www.baidu.com -> xxx

具体的实现方式如下：

- 所有的主机都维护一个本地的HOSTS文件。这个文件包含了一份域名到IP地址的映射表，以及其他相关的信息
- 当添加新主机的时候，网络管理员或系统管理员会被通知有新的机器加入网络，他们负责维护网络的HOSTS文件，添加新的主机信息
- 一旦更新完成，网络管理员需要确保这个新的HOSTS文件被传递到所有需要使用它的主机(通过复制或者网络传递等形式)

显然这种手动的、分散式的更新方式显然不够高效，尤其是在网络规模扩大的情况下，于是DNS系统应运而生。

DNS系统诞生后，本地的host文件依然没有被淘汰，比如我们可以通过(switch host等软件)修改本地的host文件来实现域名的解析

![switch host文件截图](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/switch-host-snapshot.png)


##  DNS 的解析过程

当你输入一个域名（比如'juejin.cn'）并按下回车时，操作系统会触发 DNS 解析的过程。

以下是简化的 DNS 解析过程：

- 本地缓存检查： 首先，操作系统会检查本地 DNS 缓存，看是否已经解析过这个域名。如果已经有缓存，解析过程就结束了。

- 向根域名服务器查询： 如果本地缓存没有找到对应的解析信息，系统将向配置的根域名服务器发送一个 DNS 查询请求，询问它关于域名 'juejin.cn' 的信息。

- 根域名服务器响应： 根域名服务器并不直接知道 'juejin.cn' 的 IP 地址，但它会告诉你 '.cn' 顶级域名服务器的地址。

- 向顶级域名服务器查询： 接下来，系统会向 '.cn' 顶级域名服务器发送一个 DNS 查询请求，询问它关于 'juejin.cn' 的信息。

- 顶级域名服务器响应： '.cn' 顶级域名服务器也不知道 'juejin.cn' 的具体 IP 地址，但它会告诉你关于 'juejin.cn' 的权威域名服务器的地址。

- 向权威域名服务器查询： 现在，系统向 'juejin.cn' 的权威域名服务器发送 DNS 查询请求。

- 权威域名服务器响应： 权威域名服务器最终知道 'juejin.cn' 对应的 IP 地址，并将这个信息返回给系统。

- 本地缓存更新： 解析结果返回后，系统会将这个解析结果存储在本地 DNS 缓存中，以便后续的查询能够更快速地完成。

- 应用层获得 IP 地址： 最终，操作系统将获取到的 IP 地址返回给应用程序，比如你的浏览器，以便它能够发起连接到 'juejin.cn' 的请求。


这里有几点需要注意：

1. 操作系统如何得知根服务器的地址呢？
   
 - 操作系统中有一个叫做“本地 DNS 服务器”的东西，它会在系统启动时从网络服务提供商那里获取到根域名服务器的地址，并将其缓存起来。

2. 为什么要有这么多层的 DNS 服务器呢？
 
 - DNS 服务器的数量是有限的，如果只有一个 DNS 服务器，那么它的负载将会非常大，而且容易成为攻击的目标。所以，DNS 服务器被分成了多个层级，每一层都有多台服务器，这样就可以分担负载，提高可用性。


## DNS 解析CNAME等

DNS 解析服务并不单单只有 域名 -> IP 地址一个功能，还能解析邮件服务器、CNAME 配置等


### A记录

上面一直在说的 域名 -> IP 地址 这样的 Map 记录叫做 A 记录，也即Active Record。 是最为常见的域名解析

如果你购买了服务器， 并希望将域名解析到该服务器，你需要登录到你的服务器提供商的管理面板或控制台，查找服务器的公网IP地址， 然后进入你购买域名的DNS托管提供商的网站，添加一条 A 记录，将域名解析到你的服务器 IP 地址。

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/dns-add-record.png)

### CNAME

CNAME记录用于创建一个域名的别名，将一个域名指向另一个域名。

假设你有一个GitHub Pages网站，网址是yourusername.github.io，而你希望使用自定义域名yourcustomdomain.com。在这个情景中，你可以使用CNAME记录来实现这个自定义域名的映射

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/github-cname-dns-setting.png)

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/cname-github-page.png)

### MAIL

通常用于指定与电子邮件服务相关的记录


## Nodejs 实现 DNS服务器

可参考这篇[文章](https://mp.weixin.qq.com/s/Gl94ISY5N4BYyYmVT9-QFQ)

## 参考

- https://mp.weixin.qq.com/s/Gl94ISY5N4BYyYmVT9-QFQ

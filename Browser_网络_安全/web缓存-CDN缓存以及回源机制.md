## 前言

对于部分同学而言， 对 CDN 的了解仅停留在: 点击一个`上传到CDN的按钮`或者是`webpack cdn上传插件的配置`上, 本文将介绍工作中会用到 CDN 相关的知识

## 名词解释

### CDN 的概念

CDN 全称是（Content Delivery NetWork，即内容分发网络。其目的是通过现有的 Internet 中增加一层新的缓存层，将网站的内容发布到最接近用户的网络 **边缘** 节点，使用户可以就近取得所需的内容，提高用户访问网站的响应速度。从技术上全面解决由于网络带宽小、用户访问量达、网点分布不均等问题，提高用户访问网站的响应速度。

简单来说，CDN 的工作原理就是将您源站的资源缓存到位于全球各地的 CDN 节点上，用户请求资源时，就近返回节点上缓存的资源，而不需要每个用户的请求都从您的源站获取，避免网络拥塞、缓解源站压力，保证用户访问资源的速度和体验。

### 静态资源与非静态资源

#### 静态资源

指在用户请求时不会发生变化的文件，如**图片、样式表（CSS）、脚本文件（JavaScript）**等， 静态资源的内容在**一段时间内基本上保持不变**，因此可以被缓存，减轻源服务器的负载，并提高用户的访问速度。

#### 非静态资源

指在用户请求时可能会根据不同的条件动态生成的内容，如网页的 HTML 内容、动态脚本生成的数据等。非静态资源的内容可能随着用户请求、用户身份等因素而发生变化，不能像静态资源一样长时间缓存。

## CDN 的工作原理

在理解 CDN 的工作原理之前，我们来了解 CDN 中的一些基本概念:

- **边缘节点（Edge Nodes）**: CDN 的服务器分布在全球各地，这些服务器通常被称为边缘节点。它们位于离用户更近的位置，负责缓存和提供静态资源。边缘节点之间的数据同步确保内容的一致性。

- **源服务器(Origin Server)**: 这是存储实际网站内容的原始服务器(一般也是 CDN 提供商的)。当边缘节点缓存没有所需资源时，它们会从源服务器获取资源

- **缓存清除(Cache Purge)**: 当源服务器上的内容发生更改时，需要刷新 CDN 缓存，以便下次请求时能够获取最新的内容。这可以通过手动刷新或者设置缓存过期时间来实现

- **回源(Origin Fetch)**: 当边缘节点缓存没有所需资源时，它们会执行回源操作，从源服务器获取资源。回源可以是全量回源（获取整个资源）或部分回源（只获取发生变化的部分）。

- **缓存策略(HTTP 缓存策略):** CDN 提供了多种缓存策略，包括强缓存和协商缓存。强缓存通过设置 Cache-Control 和 Expires 头来实现，而协商缓存则使用 Last-Modified 和 If-Modified-Since 或 ETag 和 If-None-Match 头。

## CDN 的配置

假设所在公司的内部 cdn 服务域名为 cdn.mycompany.com, 实际上用的是阿里云的服务 cdn.aliyun.cn, 当你通过 cdn.mycompany.com 部署的网站的静态资源到用户访问的时候，会经过以下过程:

- 阿里云注册，oss 服务会自动分配一个域名，比如 oss-cn-shanghai.aliyuncs.com, 这个域名就是**源站域名**，也就是源站服务器的域名，这个域名是不会变的，因为 oss 服务是阿里云的，所以这个域名是阿里云的域名，而不是你自己的域名，这个域名是不会变的。
- 通过 webpack 工具打包的静态资源，上传到 oss 服务上，这个过程是通过 oss 服务的 sdk 来实现的，这个 sdk 是阿里云提供的，你可以在你的项目中引入这个 sdk，然后通过这个 sdk 来上传静态资源到 oss 服务上
- 通过阿里云的 cdn 服务，将 oss 服务的域名绑定到 cdn 服务上，这个过程是通过域名解析来实现的，比如你在域名解析服务商那里，将 cdn.mycompany.com 解析到 cdn.aliyun.cn, 这样就可以通过 cdn.mycompany.com 来访问 cdn.aliyun.cn 了

用户访问时的 DNS 解析过程:

- 浏览器请求 cdn.mycompany.com: 用户在浏览器中输入 http://cdn.mycompany.com/index.js 或者页面引用了这个资源。

- 本地 DNS 解析: 浏览器首先查找本地 DNS 缓存，如果缓存中没有 cdn.mycompany.com 的解析结果，则发起 DNS 查询。

- DNS 查询: 浏览器向本地 DNS 服务器发出 DNS 查询请求，询问 cdn.mycompany.com 的 IP 地址。

- CDN 服务商的 DNS 解析: 本地 DNS 服务器可能没有 cdn.mycompany.com 的解析结果，于是它会向 CDN 服务商的 DNS 服务器发起查询请求。

- CDN 服务商的 DNS 返回结果: CDN 服务商的 DNS 服务器返回 cdn.mycompany.com 对应的 CDN 边缘节点的 IP 地址。这个 IP 地址是最近的边缘节点，确保用户能够就近获取资源。

- 建立连接: 浏览器通过获得的 IP 地址与 CDN 边缘节点建立连接。

- 请求资源: 浏览器发送请求，如 GET /index.js。

- CDN 边缘节点处理请求:

  - 如果 CDN 边缘节点有缓存，并且缓存是有效的（根据缓存策略判断），则直接返回缓存的 index.js。

  - 如果缓存失效，CDN 边缘节点会执行回源操作，从源服务器（阿里云的源服务器）获取最新的 index.js。

- 源服务器响应（回源）: CDN 边缘节点向源服务器发起请求，获取 index.js。这个请求可能经过阿里云的负载均衡，选择一个可用的源服务器。

- CDN 边缘节点缓存: 获取到源服务器的响应后，CDN 边缘节点将 index.js 缓存起来，以备将来的请求。

- 返回响应给用户: CDN 边缘节点将获取到的 index.js 返回给用户的浏览器

### Gzip 开启

Gzip 是一种文件压缩格式，可以将文件压缩到更小的体积，从而减少传输时间。Gzip 可以在 CDN 上开启，也可以在源服务器上开启。如果在源服务器上开启，CDN 会自动获取压缩后的文件。如果在 CDN 上开启，CDN 会自动压缩文件。

> 注意: 如果在 CDN 上开启 Gzip，CDN 会自动压缩文件，但是不会修改文件的 Content-Type，所以需要在源服务器上设置 Content-Type 为 gzip。

## 参考

- [腾讯云-从零开始配置 CDN](https://cloud.tencent.com/document/product/228/3149)
- https://juejin.cn/post/7268297948638249015

## 前言

本文主要介绍浏览器中的缓存机制，包括强缓存和协商缓存。

## 缓存&浏览器缓存

在计算机技术中，缓存是一种特殊的存储技术，它可以存储计算机中的数据，以便快速访问。

回到浏览器，当浏览器加载页面的时候，会把一些静态资源（图片、css、js）缓存到本地，这样下次打开页面的时候，就不用再次请求服务器，而是直接从本地读取缓存。

一来节省了流量消耗，二来也减少了服务器的压力，三来提高首屏加载速度，优化用户体验。

而缓存比较关键的点是需要有一定的策略保证缓存的失效性，否则缓存的数据就会一直存在，导致数据不准确。

## 强缓存

强缓存是利用 http 头中的 Expires 或 Cache-Control 两个字段来控制的，强缓存表示在缓存期间不需要请求，state code 为 200。

### Expires(HTTP/1.0)

HTTP/1.0 引入了一些简单的缓存机制，其中最主要的就是通过服务器端的 Expires 头。当服务器返回资源时，通过设置 Expires 头，指定了资源的过期时间。浏览器在请求该资源时，会检查本地缓存，如果资源仍在有效期内，浏览器将直接使用缓存而不发出请求，从而减少了对服务器的访问。

> Expires: Fri, 30 Dec 2022 23:59:59 GMT

上述头部表示资源的过期时间为 2022 年 12 月 30 日 23:59:59 GMT。在过期时间之前，浏览器将直接使用缓存，而不会向服务器发起请求。

然而，Expires 头存在一些问题和挑战。其中之一是时间戳的管理。如果服务器和浏览器的时钟不同步，或者用户在不同时区访问网站，可能导致缓存的失效时间不准确。这可能导致浏览器不恰当地使用过期的缓存，或者在实际资源仍然有效时不使用缓存。

### max-age 与 Cache-Control

HTTP/1.1 引入了 max-age, 相比于 Expires 头， max-age 使用的是**相对时间**，而不是绝对时间。

同时为了提供更灵活和细粒度的缓存控制, HTTP/1.1 还引入了 Cache-Control 头。Cache-Control 头提供了更多的指令和选项，使得服务器和浏览器可以更精确地定义缓存策略。

以下是一些常见的 Cache-Control 指令：

- **max-age: 指定资源的最大缓存时间，以秒为单位。例如，max-age=60 表示资源在 60 秒后过期。**
- no-store: 指示不应存储任何关于客户端请求和服务器响应的内容。每次都需要重新获取完整的响应。
- no-cache: 表示缓存必须重新验证资源的有效性，即需要向服务器发送请求确认资源是否过期。
- public: 表示响应可以被任何缓存存储，包括代理服务器。
- private: 表示响应仅能被单个用户缓存，不允许代理服务器缓存。

这里插个题外话，浏览器的硬刷新（hard reload）和普通刷新（refresh）都使用了 HTTP 请求头中的 Cache-Control 头，但是具体的指令值有所不同。

1. 硬刷新（Hard Reload）：

- 请求头： Cache-Control: no-cache 或者 Cache-Control: no-store。

- 作用： 这样的请求头告诉服务器不要使用缓存，每次都需要从服务器获取最新的资源。no-cache 表示需要服务器验证资源是否过期，而 no-store 表示不应存储任何关于客户端请求和服务器响应的内容，每次都需要重新获取完整的响应。硬刷新的目的是强制浏览器忽略缓存并从服务器获取最新的资源。

2. 普通刷新（Refresh）：

- 请求头： 普通刷新一般使用默认的请求头，不会明确指定 Cache-Control 头，因此可能是默认的缓存行为。
- 作用： 浏览器可能根据缓存策略（例如 Cache-Control 头中的设置）来判断是否使用缓存。如果资源在缓存有效期内，浏览器可能直接使用缓存而不重新请求。


## 协商缓存

协商缓存是一种缓存控制策略，它依赖于服务器和浏览器之间的通信，以验证缓存的有效性。与强缓存不同，协商缓存并不直接使用本地缓存，而是通过与服务器的交互，检查资源是否已经发生变化。

以下是协商缓存的基本原理和相关头部：

### Last-Modified 和 If-Modified-Since：

- 服务器行为： 当服务器返回资源时，会附带一个 Last-Modified 头，该头包含了资源的最后修改时间。
- 浏览器行为： 浏览器在后续请求该资源时，会在请求头中包含一个 If-Modified-Since 头，该头的值是上一次获取资源时服务器返回的 Last-Modified 值。
- 验证过程： 服务器收到请求后，会检查 If-Modified-Since 的值与当前资源的最后修改时间是否一致。如果一致，表示资源未发生变化，服务器返回 304 Not Modified 状态码，告诉浏览器可以使用缓存。否则，服务器返回新的资源和状态码 200 OK。

### ETag 和 If-None-Match：

- 服务器行为： 服务器可以为每个资源生成一个唯一的标识符，称为 ETag（实体标签）。当返回资源时，服务器会包含一个 ETag 头。
- 浏览器行为： 浏览器在后续请求该资源时，会在请求头中包含一个 If-None-Match 头，该头的值是上一次获取资源时服务器返回的 ETag 值。
- 验证过程： 服务器收到请求后，会比较 If-None-Match 的值与当前资源的 ETag 是否一致。如果一致，表示资源未发生变化，服务器返回 304 Not Modified 状态码。否则，服务器返回新的资源和状态码 200 OK。


> 本节对应的代码在`_demo/browser-cache`目录下。

## 参考

- https://juejin.cn/post/7100747501338099749

## å‰è¨€

å‰ç«¯æˆªå›¾çš„éœ€æ±‚åœ¨å®é™…å¼€å‘ä¸­æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬éœ€è¦å¯¼å‡ºé¡µé¢æˆªå›¾ä½œä¸ºæµ·æŠ¥ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è€ƒè™‘åç«¯çš„æƒ…å†µï¼Œåªè€ƒè™‘å‰ç«¯çš„å®ç°ã€‚æœ¬æ–‡å°†è®¨è®ºä»¥ä¸‹å‡ ç‚¹:

- å¦‚ä½•å®ç°å‰ç«¯æˆªå›¾ä»¥åŠä¸ºä»€ä¹ˆä¼šå‡ºç°è·¨åŸŸé—®é¢˜
- html2canvas çš„åŸç†
- dom2image çš„å·¥ä½œåŸç†

## å‰ç«¯æˆªå›¾åŸç†ä»¥åŠè·¨åŸŸé—®é¢˜

### å‰ç«¯æˆªå›¾åŸºæœ¬æ€è·¯

- è·å– DOM å…ƒç´ , é€šè¿‡éå† DOM å…‹éš†ä¸€ä»½å‰¯æœ¬
- åˆ©ç”¨ SVG çš„ foreignObject æ ‡ç­¾/Canvas çš„ drawImage æ–¹æ³•å°† DOM ç»˜åˆ¶åˆ°ç”»å¸ƒä¸Š
- åˆ©ç”¨ canvas.toDataURL æ–¹æ³•å°†ç”»å¸ƒè½¬æ¢ä¸ºå›¾ç‰‡

### è·¨åŸŸé—®é¢˜

åœ¨å®è·µä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè‡ªå·±çš„é¡µé¢å¯ä»¥æ­£å¸¸æ¸²æŸ“å›¾ç‰‡ç­‰è·¨åŸŸèµ„æºï¼Œä½†æ˜¯ä¸€æ—¦ä½¿ç”¨ html2canvas ç­‰æ–¹æ¡ˆè¿›è¡Œæˆªå›¾çš„æ—¶å€™å°±ä¼šå‡ºç°è·¨åŸŸé—®é¢˜ï¼Œ

è¿™æ˜¯å› ä¸ºæµè§ˆå™¨åœ¨åŠ è½½é¡µé¢æ—¶å¯¹éåŒæºçš„èµ„æºï¼ˆå¦‚å›¾ç‰‡ï¼‰æœ‰ä¸€äº›é»˜è®¤çš„è·¨åŸŸç­–ç•¥ï¼Œå…è®¸åŠ è½½å¹¶æ˜¾ç¤ºè¿™äº›èµ„æºã€‚

ä½†æˆ‘ä»¬å°è¯•ä»¥ç¼–ç¨‹æ–¹å¼å…‹éš†å›¾åƒèŠ‚ç‚¹å¹¶ä¸”å›¾åƒæ‰˜ç®¡åœ¨ä¸åŒçš„åŸŸä¸Šæ—¶ï¼Œæµè§ˆå™¨ä¼šè®¤ä¸ºè¿™æ˜¯æ½œåœ¨çš„å®‰å…¨é£é™©ï¼Œå¹¶å®æ–½è·¨åŸŸé™åˆ¶

## html2canvas çš„åŸç†

æºç ä¸­ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š

- é€’å½’å–å‡ºç›®æ ‡æ¨¡ç‰ˆçš„æ‰€æœ‰ DOM èŠ‚ç‚¹ï¼Œå¡«å……åˆ°ä¸€ä¸ª rederListï¼Œå¹¶é™„åŠ æ˜¯å¦ä¸ºé¡¶å±‚å…ƒç´ /åŒ…å«å†…å®¹çš„å®¹å™¨ç­‰ä¿¡æ¯
- é€šè¿‡ z-index postion float ç­‰ css å±æ€§å’Œå…ƒç´ çš„å±‚çº§ä¿¡æ¯å°† rederList æ’åºï¼Œè®¡ç®—å‡ºä¸€ä¸ª canvas çš„ renderQueue
- éå† renderQueueï¼Œå°† css æ ·å¼è½¬ä¸º setFillStyle å¯è¯†åˆ«çš„å‚æ•°ï¼Œä¾æ® nodeType è°ƒç”¨ç›¸å¯¹åº” canvas æ–¹æ³•ï¼Œå¦‚æ–‡æœ¬åˆ™è°ƒç”¨ fillTextï¼Œå›¾ç‰‡ drawImageï¼Œè®¾ç½®èƒŒæ™¯è‰²çš„ div è°ƒç”¨ fillRect ç­‰
- å°†ç”»å¥½çš„ canvas å¡«å……è¿›é¡µé¢

æ— è®ºæ˜¯æ’åºè®¡ç®—è¿˜æ˜¯ css åˆ° canvas çš„è½¬åŒ–ï¼Œéƒ½æ˜¯åŠå…¶å¤æ‚çš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¹Ÿå¯¼è‡´å…¶æ‰§è¡Œé€Ÿåº¦æ…¢ã€‚å…¶åº•å±‚ä½¿ç”¨äº† canvas è¿›è¡Œæˆªå›¾ï¼Œæ‰€ä»¥ canvas å­˜åœ¨çš„é—®é¢˜ï¼Œhtml2canvas ä¹Ÿå­˜åœ¨ã€‚

å…·ä½“çœ‹[æºç ](https://github.com/niklasvh/html2canvas)

ä¼˜ç‚¹ï¼š

- èƒ½åœ¨å„ç§è®¾å¤‡æ‰§è¡Œ
- æˆªå›¾èŠ‚ç‚¹é¢—ç²’åº¦å°ï¼Œå¯é…ç½®
- è¿˜åŸåº¦é«˜

Ã¥ç¼ºç‚¹ï¼š
- è¿è¡Œé€Ÿåº¦æ…¢
- å¤§å›¾å¯èƒ½å‡ºç°ä¸æ¸…æ™°ï¼Œéœ€è¦è°ƒæ•´é…ç½®

é™åˆ¶ï¼š
- æ— æ³•è·¨åŸŸè·¨åŸŸèµ„æº
- æ— æ³•æ¸²æŸ“ iframeï¼Œflash ç­‰å†…å®¹ï¼Œä½†ç›®å‰æ”¯æŒ svg
- ä½¿ç”¨ Canvas æˆªå›¾å…¼å®¹ä½ç‰ˆæœ¬æµè§ˆå™¨æ—¶ï¼Œä¸èƒ½ä½¿ç”¨ CSS3 å±æ€§å’Œå¸¦æœ‰å‰ç¼€çš„å±æ€§
- ä¸æ”¯æŒçš„ css æ ·å¼ï¼šhttps://html2canvas.hertzen.com/features

ç®€æ˜“ç‰ˆå®ç°å¦‚ä¸‹:

```js
function capture() {
  const contentElement = document.getElementById("content");
  const canvas = document.createElement("canvas");
  const context = canvas.getContext("2d");
  // è®¾ç½®canvasçš„å°ºå¯¸ä¸å†…å®¹å°ºå¯¸ç›¸åŒ¹é…
  canvas.width = contentElement.offsetWidth;
  canvas.height = contentElement.offsetHeight;
  // å°†å†…å®¹ç»˜åˆ¶åˆ°canvasä¸Š
  drawElement(contentElement, context, 0, 0);
  // å°†canvasæ·»åŠ åˆ°bodyä¸­
  document.body.appendChild(canvas);
}
function drawElement(element, context, offsetX, offsetY) {
  if (element.tagName === "P") {
    // ç»˜åˆ¶å…ƒç´ çš„èƒŒæ™¯é¢œè‰²
    context.fillStyle = window.getComputedStyle(element).backgroundColor;
    context.fillRect(
      offsetX,
      offsetY,
      element.offsetWidth,
      element.offsetHeight
    );
    // ç»˜åˆ¶å…ƒç´ çš„æ–‡æœ¬å†…å®¹
    context.fillStyle = window.getComputedStyle(element).color;
    context.font = window.getComputedStyle(element).font;
    context.fillText(
      element.textContent,
      offsetX,
      offsetY + element.offsetHeight / 2
    );
  } else if (element.tagName === "IMG") {
    // å°†å›¾ç‰‡ç»˜åˆ¶åˆ°canvasä¸Š
    context.drawImage(
      element,
      offsetX,
      offsetY,
      element.offsetWidth,
      element.offsetHeight
    );
  } else if (element.tagName === "DIV") {
    context.fillStyle = window.getComputedStyle(element).backgroundColor;
    context.fillRect(
      offsetX,
      offsetY,
      element.offsetWidth,
      element.offsetHeight
    );
    // é€’å½’ç»˜åˆ¶å­å…ƒç´ 
    for (const i = 0; i < element.children.length; i++) {
      drawElement(
        element.children[i],
        context,
        offsetX + element.children[i].offsetLeft,
        offsetY + element.children[i].offsetTop
      );
    }
  }
}
```

â—æ³¨æ„ï¼šä¸Šè¿°çš„å®ç°ä¸­ï¼Œå¹¶æ²¡æœ‰çœŸæ­£å¯¼å‡ºå›¾ç‰‡ï¼Œä¸€æ—¦ä½¿ç”¨canvas.toDataURLå¯¼å‡ºçš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼ŒåŸå› ä¸Šé¢æè¿‡äº†

```js
const imageDataURL = canvas.toDataURL();
document.getElementById("output").src = imageDataURL;
```

æ•ˆæœï¼š

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/html-2-canvas-simple-version.png)

å®Œæ•´çš„ demo è¯·çœ‹ ğŸ‘‰ [åœ¨çº¿æ•ˆæœé¢„è§ˆ](https://chenxiaoyao6228.github.io/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/Javascript/_demo/frontend-screenshot/html2canvas.html), æŸ¥çœ‹ç¤ºä¾‹ä»£ç è¯·ç‚¹å‡»[æ­¤å¤„](./_demo/frontend-screenshot/html2canvas.html)

## dom2image çš„å·¥ä½œåŸç†

åº•å±‚æ˜¯ä½¿ç”¨ SVG å®ç°ï¼š

- é€’å½’å…‹éš†åŸå§‹ DOM èŠ‚ç‚¹
- è®¡ç®—èŠ‚ç‚¹å’Œæ¯ä¸ªå­èŠ‚ç‚¹çš„æ ·å¼ï¼Œç„¶åå°†å…¶å¤åˆ¶åˆ°ç›¸åº”çš„å…‹éš†èŠ‚ç‚¹ä¸­
- åµŒå…¥ç½‘ç»œå­—ä½“
- åµŒå…¥å›¾ç‰‡
- å°†å…‹éš†çš„èŠ‚ç‚¹åºåˆ—åŒ–ä¸º XML
- å°† XML åŒ…è£…åˆ°<foreignObject>æ ‡ç­¾ä¸­ï¼Œç„¶ååŒ…è£…åˆ° SVG ä¸­ï¼Œç„¶åä½¿å…¶æˆä¸ºæ•°æ® URL
- å°†æ•°æ® URL ä¼ é€’ç»™ Imageï¼Œç„¶åå°†å…¶ç»˜åˆ¶åˆ° Canvas ä¸Š

ä¼˜ç‚¹ï¼š

- æˆªå›¾é€Ÿåº¦å¿«
- ä½¿ç”¨ç®€å•
- ä»£ç å°‘
- ä¸ä»…æ¸…æ™°åº¦æœ‰æ‰€æé«˜ï¼Œèƒ½å¤Ÿæ”¯æŒçš„å›¾ç‰‡æ ¼å¼å’Œ dom èŠ‚ç‚¹æ ·å¼ä¹Ÿæ¯” html2canvas è¦å¤šã€‚

ç¼ºç‚¹ï¼š
- ç¤¾åŒºå·²åœæ­¢ç»´æŠ¤ï¼Œç°æ¨è[dom-to-image-more](https://www.npmjs.com/package/dom-to-image-more)æˆ–è€…[html-to-image](https://www.npmjs.com/package/html-to-image)
- safari é‡Œæ”¯æŒéå¸¸ä¸å‹å¥½ï¼ŒIOS ä¸èƒ½ä½¿ç”¨

é™åˆ¶ï¼š
- æœ‰äº›æ ·å¼ä¸èƒ½å¾ˆå…¼å®¹ï¼Œå¦‚å›¾å½¢é®ç½© mask-box-imageï¼Œå’Œ svg çš„é˜´å½± drop-shadow ç­‰

ç®€æ˜“ç‰ˆå®ç°å¦‚ä¸‹:

```js
function capture() {
  const contentElement = document.getElementById("content");
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  const foreignObject = document.createElementNS(
    "http://www.w3.org/2000/svg",
    "foreignObject"
  );
  const image = new Image();

  // è®¾ç½®SVGçš„å°ºå¯¸ä¸å†…å®¹å°ºå¯¸ç›¸åŒ¹é…
  svg.setAttribute("width", contentElement.offsetWidth);
  svg.setAttribute("height", contentElement.offsetHeight);

  // å°†è¦æˆªå›¾çš„å†…å®¹åŒ…è£¹åœ¨foreignObjectä¸­
  foreignObject.setAttribute("width", contentElement.offsetWidth);
  foreignObject.setAttribute("height", contentElement.offsetHeight);
  drawElement(contentElement, foreignObject, 0, 0);

  // å°†foreignObjectæ·»åŠ åˆ°SVGä¸­
  svg.appendChild(foreignObject);

  // å°†SVGè½¬æ¢ä¸ºDataURL
  const svgData = new XMLSerializer().serializeToString(svg);
  const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgData);

  // åˆ›å»ºä¸€ä¸ªå›¾åƒå¯¹è±¡ï¼ŒåŠ è½½DataURL
  image.onload = function () {
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");

    // è®¾ç½®canvasçš„å°ºå¯¸ä¸å†…å®¹å°ºå¯¸ç›¸åŒ¹é…
    canvas.width = contentElement.offsetWidth;
    canvas.height = contentElement.offsetHeight;

    // å°†å›¾åƒç»˜åˆ¶åˆ°canvasä¸Š
    context.drawImage(image, 0, 0, canvas.width, canvas.height);

    // å°†canvasè½¬æ¢ä¸ºDataURL
    const imageDataURL = canvas.toDataURL();

    document.getElementById("output").src = imageDataURL;
  };
  image.src = url;
}

function convertImageToBase64(img) {
  const canvas = document.createElement("canvas");
  canvas.width = img.width;
  canvas.height = img.height;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0);
  return canvas.toDataURL("image/png");
}

function drawElement(element, parentElement, offsetX, offsetY) {
  if (element.tagName === "P") {
    // ç»˜åˆ¶å…ƒç´ çš„èƒŒæ™¯é¢œè‰²
    parentElement.style.backgroundColor =
      window.getComputedStyle(element).backgroundColor;

    // ç»˜åˆ¶å…ƒç´ çš„æ–‡æœ¬å†…å®¹
    parentElement.textContent = element.textContent;
  } else if (element.tagName === "IMG") {
    // éœ€è¦å¤„ç†è·¨åŸŸé—®é¢˜
    const dataUrl = convertImageToBase64(element);
    // åˆ›å»ºä¸€ä¸ªæ–°çš„imageå…ƒç´ ï¼Œå¹¶è®¾ç½®å…¶å±æ€§
    const image = document.createElementNS("http://www.w3.org/1999/xhtml", "img");
    image.src = dataUrl;
    image.alt = element.alt;
    image.style.width = element.offsetWidth + "px";
    image.style.height = element.offsetHeight + "px";

    // å°†imageå…ƒç´ æ·»åŠ åˆ°çˆ¶å…ƒç´ ä¸­
    parentElement.appendChild(image);
  } else if (element.tagName === "DIV") {
    // åˆ›å»ºä¸€ä¸ªæ–°çš„divå…ƒç´ ï¼Œå¹¶è®¾ç½®å…¶å±æ€§
    const div = document.createElementNS("http://www.w3.org/1999/xhtml", "div");
    div.style.width = element.offsetWidth + "px";
    div.style.height = element.offsetHeight + "px";

    // é€’å½’ç»˜åˆ¶å­å…ƒç´ 
    for (const i = 0; i < element.children.length; i++) {
      drawElement(
        element.children[i],
        div,
        element.children[i].offsetLeft,
        element.children[i].offsetTop
      );
    }

    // å°†divå…ƒç´ æ·»åŠ åˆ°çˆ¶å…ƒç´ ä¸­
    parentElement.appendChild(div);
  }
}
```

å®Œæ•´çš„ demo è¯·çœ‹ ğŸ‘‰ [åœ¨çº¿æ•ˆæœé¢„è§ˆ](https://chenxiaoyao6228.github.io/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/Javascript/_demo/frontend-screenshot/dom-to-image.html), æŸ¥çœ‹ç¤ºä¾‹ä»£ç è¯·ç‚¹å‡»[æ­¤å¤„](./_demo/frontend-screenshot/dom-to-image.html)


## æ‰©å±•é˜…è¯»

- https://juejin.cn/post/7287913415803764747
- https://www.51cto.com/article/711099.html
- https://juejin.cn/post/7277045020423798840
- https://juejin.cn/post/7075211593427976229
- https://mp.weixin.qq.com/s?__biz=MzIzNjcwNzA2Mw==&mid=2247485913&idx=1&sn=32ec96e6a6017370f62976d4e02b5790
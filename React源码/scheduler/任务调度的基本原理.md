---
permalink: 2023-08-01-react-scheduler-first-glance
title: ä»»åŠ¡è°ƒåº¦çš„åŸºæœ¬åŸç†
date: 2023-08-01
categories:
  - tech
tags:
  - react
---

## å‰è¨€

React fiber æ¶æ„ä¸­å¼•å…¥äº†`ä»»åŠ¡è°ƒåº¦`çš„æ¦‚å¿µå¹¶å®ç°äº†`scheduler`ï¼Œä½†æ˜¯ä»»åŠ¡è°ƒåº¦æ˜¯æ¡†æ¶æ— å…³çš„
å¾ˆå¤šæ–‡ç« åˆ†æçš„æ—¶å€™éƒ½ä¼šæ¬æ¥è®¡ç®—æœºä¸­æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œå…¶ä»–è¯­è¨€ä¸­çš„è¿›ç¨‹ç®¡ç†ç­‰æ¦‚å¿µï¼Œå¯¹äºå‰ç«¯æ¥è¯´çŸ¥è¯†å¯†åº¦æ¯”è¾ƒé«˜ä¸æ˜“ç†è§£ã€‚å› æ­¤æœ¬æ–‡æ‰“ç®—ä»æ¡ˆä¾‹å‡ºå‘ç»“åˆ chrome performance å·¥å…·ä¸€æ­¥æ­¥å‰–æ`ä»»åŠ¡è°ƒåº¦`çš„åŸç†ã€‚

æœ¬æ–‡å°è¯•è§£ç­”ä»¥ä¸‹é—®é¢˜ï¼š

- æµè§ˆå™¨çš„æ¸²æŸ“æµç¨‹ä¸é•¿ä»»åŠ¡çš„å½±å“
- ä¸ºä»€ä¹ˆéœ€è¦ä»»åŠ¡è°ƒåº¦ï¼Œä¸ä»€ä¹ˆæ˜¯åˆä½œä»»åŠ¡è°ƒåº¦
- ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨å®ä»»åŠ¡è€Œä¸æ˜¯å¾®ä»»åŠ¡è¿›è¡Œè°ƒåº¦
- ä½¿ç”¨ setTimeout è°ƒåº¦çš„é—®é¢˜
- message Channel ä½œä¸ºè°ƒåº¦æ–¹æ¡ˆ
- ä»€ä¹ˆæ˜¯ä»»åŠ¡åˆ‡ç‰‡ï¼Ÿä»€ä¹ˆæ˜¯æ—¶é—´åˆ‡ç‰‡

## åŒæ­¥é•¿ä»»åŠ¡å µå¡é¡µé¢æ›´æ–°

æˆ‘ä»¬çŸ¥é“ï¼Œæµè§ˆå™¨æ˜¯ä¸€ä¸ªä¸­çš„ JS çº¿ç¨‹å’Œ UI æ¸²æŸ“çº¿ç¨‹æ˜¯äº’æ–¥çš„ã€‚é•¿æ—¶é—´çš„ JS åŒæ­¥ä»»åŠ¡ä¼šé˜»å¡æµè§ˆå™¨æ¸²æŸ“ï¼Œå¯¼è‡´é¡µé¢å¡é¡¿(åŠ¨ç”»æ‰§è¡Œå¡é¡¿)ç”šè‡³å¤±å»ç›¸åº”(ç”¨æˆ·è¾“å…¥ä¸å“åº”).

è¿™é‡Œé€šè¿‡ä¸€ä¸ª Demo è¿›è¡Œæ•ˆæœæ¼”ç¤ºã€‚å½“ç‚¹å‡»`ç‚¹å‡»æ¨¡æ‹Ÿä»»åŠ¡`çš„æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€æ®µ JS ä»£ç ï¼Œè¿™æ®µä»£ç ä¼šåŠ¨æ€åˆ›å»º 3000 ä¸ªä»»åŠ¡åŒºæ‰§è¡Œï¼Œæ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä¸º 2msï¼Œ æ€»ä½“çš„ä»»åŠ¡æ—¶é—´ä¸º 6000ms(å¯èƒ½æœ‰è¯¯å·®ï¼Œä½†æ•´ä½“ä¸å¤§)

```js
// ----------ä»»åŠ¡åˆ›å»º----------
const createWorks = () => {
  const taskDuration = 2;
  let works = [];
  for (let i = 0; i < 3000; i++) {
    const work = () => {
      let startTime = Date.now();
      while (Date.now() - startTime < taskDuration) {
        // æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œæ—¶é—´
      }
    };
    works.push(work);
  }
  return works;
};
const works = createWorks();

//  -------æ›´æ–°é¡µé¢------
const flushWorks = () => {
  works.forEach((work) => work());
};
```

é€šè¿‡è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œåœ¨ç‚¹å‡»äº† button ä¹‹å JS æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œæ•´ä¸ªé¡µé¢æ˜¯å¤„äº freeze çŠ¶æ€ï¼Œè¿™å¿…ç„¶æ˜¯å¾ˆå½±å“ç”¨æˆ·ä½“éªŒçš„ã€‚

é€šè¿‡ Performance é¢æ¿æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ª JS çš„ä»»åŠ¡æ‰§è¡Œæ—¶é—´éå¸¸é•¿ï¼Œå› æ­¤æˆ‘ä»¬å¾—æƒ³åŠæ³•ä¼˜åŒ–è¿™éƒ¨åˆ†çš„é€»è¾‘ã€‚

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/react-source-scheduler-long-task.png)

ğŸ‘‰ [åœ¨çº¿æ•ˆæœé¢„è§ˆ](https://chenxiaoyao.cn/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/React%E6%BA%90%E7%A0%81/_demo/scheduler/2-sync-long-task.html), æˆ–è€…ä¸‹è½½[æºç ](../_demo/scheduler/1-long-sync-task.html)åæ‰“å¼€(**ä¸ºé¿å…æµè§ˆå™¨æ’ä»¶å½±å“ï¼Œè¯·åœ¨æ— ç—•æ¨¡å¼ä¸‹æ‰“å¼€**)

## setTimeout å¼‚æ­¥æ›´æ–°

æ—¢ç„¶æˆ‘ä»¬çš„åŒæ­¥çš„é•¿ä»»åŠ¡ä¸å¯æ¥å—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æƒ³åŠæ³•å°†ä»»åŠ¡å˜æˆå¯ä¸­æ–­çš„ã€‚åŒæ—¶ä½¿ç”¨å®ä»»åŠ¡ API setTimeout è¿›è¡Œå¼‚æ­¥æ›´æ–°(å½“ç„¶åœ¨å®é™…è¿‡ç¨‹ä¸­æˆ‘ä»¬è¦è€ƒè™‘æ›´å¤šçš„å› ç´ ï¼Œæ¯”å¦‚æ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¿å­˜ä»¥åŠä¸­æ–­ä¹‹åçš„æ¢å¤, å¦‚ React Fiber æ¶æ„)

> æ³¨æ„æ­¤å¤„ä¸å¯ä½¿ç”¨å¾®ä»»åŠ¡ API å¦‚ `Promise`ï¼Œå› ä¸ºå¾®ä»»åŠ¡ä¼šåœ¨ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åå…¨éƒ¨æ‰§è¡Œï¼Œå®é™…æ•ˆæœå°±å’ŒåŒæ­¥æ‰§è¡Œå·®ä¸å¤šäº†ï¼Œå…³äº[å®ä»»åŠ¡å¾®ä»»åŠ¡çš„ç›¸å…³çŸ¥è¯†ç‚¹å¯ä»¥çœ‹è¿™é‡Œçš„ä»‹ç»](../../Javascript/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6.md)

```js
// --------ä»»åŠ¡è°ƒåº¦--------
const workLoop = () => {
  const work = works.shift();
  if (work) {
    work();
    setTimeout(workLoop, 0);
  } else {
    updateView(Date.now() - startTime);
  }
};

const flushWorks = () => {
  setTimeout(workLoop, 0);
};
```

ç‚¹å‡»æŒ‰é’®è§‚å¯Ÿé¡µé¢å¯ä»¥å‘ç°ï¼Œç»è¿‡ setTimeout è¿›è¡Œå¼‚æ­¥æ›´æ–°åï¼Œç°åœ¨ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™å·²ç»ä¸ä¼šé˜»å¡é¡µé¢åŠ¨ç”»æ¸²æŸ“äº†ã€‚ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯ setTimeout çš„è°ƒåº¦æ—¶æœºé—®é¢˜ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨ä»£ç é‡Œé¢å†™äº†`setTimeout(workLoop, 0)`, ä½†æ˜¯å®é™…ä¸Šæµè§ˆå™¨æ¯æ¬¡è°ƒåº¦çš„æ—¶å€™çš„éƒ½ä¼šæœ‰ä¸€ä¸ª 4ms çš„å»¶è¿Ÿï¼Œä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºåœ¨ä¸€å¸§çš„æ—¶é—´å†…ä»…æ‰§è¡Œäº† 3 ä¸ªä»»åŠ¡ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†æ€»ä»»åŠ¡æ‰§è¡Œæ—¶é•¿å˜ä¸ºäº† 18sï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥æé«˜è°ƒåº¦çš„é¢‘ç‡å‘¢ï¼Ÿ

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/react-source-scheduler-setTimeout.png)

ğŸ‘‰ [åœ¨çº¿æ•ˆæœé¢„è§ˆ](https://chenxiaoyao6228.github.io/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/Reactæºç /_demo/scheduler/3-asyn-setTimeout.html), æˆ–è€…ä¸‹è½½[æºç ](../_demo/scheduler/3-asyn-setTimeout.html)åæ‰“å¼€

## messageChannel å¼‚æ­¥æ›´æ–°

ä¸Šé¢æåˆ°äº†æˆ‘ä»¬éœ€è¦æé«˜æµè§ˆå™¨çš„è°ƒåº¦é¢‘ç‡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ messageChannel æ¥å®ç°å¯¹åº”çš„åŠŸèƒ½ã€‚å®é™…ä¸Šå¦‚æœæˆ‘ä»¬ä¸è€ƒè™‘ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´, å•çº¯æµ‹è¯• messageChannel çš„è°ƒç”¨æ¬¡æ•°çš„è¯ï¼Œå…¶è¡¨ç°æ•ˆæœè¿˜æ˜¯å¾ˆäº®çœ¼çš„ï¼Œ1s å†…çš„è°ƒç”¨æ¬¡æ•°å¯ä»¥è¾¾åˆ° 16 ä¸‡æ¬¡(å–å†³äºæœºå™¨çš„æ€§èƒ½ã€‚)

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/react-source-scheduler-message-channel-performance.png)

ğŸ‘‰ [åœ¨çº¿æ•ˆæœé¢„è§ˆ](https://chenxiaoyao6228.github.io/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/Reactæºç /_demo/scheduler/5-message-channel-performance.html), æˆ–è€…ä¸‹è½½[æºç ](../_demo/scheduler/5-message-channel-performance.html)åæ‰“å¼€

æœ‰äº†ä¸Šé¢çš„æ•°æ®ï¼Œæˆ‘ä»¬ä½¿ç”¨ messageChannel æ¥æ”¹é€ æˆ‘ä»¬çš„ç¤ºä¾‹ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ä¸ç†Ÿæ‚‰ messageChannel çš„æœ‹å‹ç†è§£ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿ setTimeout çš„ä½¿ç”¨æ–¹å¼æ¥ä½¿ç”¨ messageChannel è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼Œå…¶ä½™ä»£ç ä¿æŒä¸å˜ã€‚

```js
const _setTimeout = ((workLoop) => {
  let channel = null;
  return (onMessageCb) => {
    if (!channel) {
      channel = new MessageChannel();
      channel.port1.onmessage = onMessageCb;
    }
    channel.port2.postMessage(null);
  };
})();

const workLoop = () => {
  const work = works.shift();
  if (work) {
    work();
    _setTimeout(workLoop);
  } else {
    updateView(Date.now() - startTime);
  }
};
```

é€šè¿‡ Performance é¢æ¿å¯ä»¥å‘ç°ï¼Œåœ¨æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸º 2ms çš„æƒ…å†µä¸‹ï¼Œä¸€å¸§å†…å¯ä»¥æ‰§è¡Œçš„ä»»åŠ¡æ•°ä¸º 8ã€‚ä½†å³ä¾¿å¦‚æ­¤ï¼Œä¾ç„¶å­˜åœ¨ä¸€å®šçš„è°ƒåº¦è€—æ—¶ã€‚

![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/react-source-scheduler-message-channel.png)

ğŸ‘‰ [åœ¨çº¿æ•ˆæœé¢„è§ˆ](https://chenxiaoyao6228.github.io/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/Reactæºç /_demo/scheduler/4-async-message-channel.html), æˆ–è€…ä¸‹è½½[æºç ](../_demo/scheduler/4-async-message-channel.html)åæ‰“å¼€

## ä»»åŠ¡åˆ‡ç‰‡

åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æœ‰è¿™æ ·çš„æƒ³æ³•ï¼šâ€œå°½é‡å‡å°‘ä»»åŠ¡è°ƒåº¦çš„æ¬¡æ•°â€ä¸å°±å¯ä»¥äº†å—ï¼Ÿæˆ‘ä»¬å¯ä»¥æ”¹é€ ä¸‹ workLoop å‡½æ•°ï¼Œè®©å°½å¯èƒ½å¤šçš„ä»»åŠ¡åœ¨ä¸€å¸§å†…æ‰§è¡Œã€‚

```js
const workLoop = () => {
  let workExecutedCount = 0;
  while (workExecutedCount < 7) {
    const work = works.shift();
    if (work) {
      work();
      workExecutedCount++;
    } else {
      updateView(Date.now() - startTime);
      break;
    }
  }
  if (works.length) {
    _setTimeout(workLoop);
  }
};
```

é€šè¿‡ Performance é¢æ¿å¯ä»¥çœ‹åˆ°ï¼Œæ€§èƒ½ç•¥å¾®æœ‰æå‡ã€‚
![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/react-source-scheduler-task-slicing.png)

## æ—¶é—´åˆ‡ç‰‡

ä¸Šè¿°çš„â€œä»»åŠ¡åˆ‡ç‰‡â€æ–¹æ¡ˆæ˜¯åŸºäºæˆ‘ä»¬å·²çŸ¥å•ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´çš„å‰æä¸‹ï¼Œä½†æ˜¯åœ¨å®é™…ä¸šåŠ¡ä¸­æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ˜¯ä¸ç¡®å®šçš„ã€‚å› æ­¤æˆ‘ä»¬å¯èƒ½ä¼šæƒ³åˆ°å¦å¤–ä¸€ç§åˆ‡ç‰‡çš„æ–¹å¼ï¼šâ€œæ—¶é—´åˆ‡ç‰‡â€ã€‚ ç»™å®šä¸€ä¸ªé¢„å®šçš„æ—¶é—´æ¯”å¦‚ 5ms, æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åéƒ½ä¼šå»åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¶…å‡ºäº†æ—¶é—´åˆ†ç‰‡çš„é™åˆ¶ï¼Œå¦‚æœæ˜¯çš„è¯å°±è®©å‡ºæ‰§è¡Œæƒäº¤ç»™æµè§ˆå™¨å»æ¸²æŸ“ã€‚

è¿™é‡Œæˆ‘ä»¬æ¥æ”¹é€ ä¸‹ createWorks æ–¹æ³•ï¼Œæ¯æ¬¡ç”Ÿæˆä¸€ä¸ªåœ¨ 0-1 æ¯«ç§’ä¹‹å†…çš„ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œï¼ŒæŸ¥çœ‹æ•ˆæœã€‚

```js
const createWorks = () => {
  const taskDuration = Math.random(); // éšæœºç”Ÿæˆ 0-1
  let works = [];

  for (let i = 0; i < 3000; i++) {
    works.push(() => {
      const start = performance.now();
      const time = Math.random();
      while (performance.now() - start < time) {}
    });
  }
  return works;
};
const works = createWorks();
```

å¯¹åº”çš„æ•ˆæœå¦‚ä¸‹ï¼š
![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/react-source-scheduler-time-slicing.png)

ğŸ‘‰ [åœ¨çº¿æ•ˆæœé¢„è§ˆ](https://chenxiaoyao6228.github.io/html-preview/?https://github.com/chenxiaoyao6228/fe-notes/blob/main/Reactæºç /_demo/scheduler/7-async-time-slicing.html), æˆ–è€…ä¸‹è½½[æºç ](../_demo/scheduler/7-async-time-slicing.html)åæ‰“å¼€

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»åˆæ­¥äº†è§£äº†è°ƒåº¦ç›¸å…³çš„çŸ¥è¯†ï¼Œä¸‹ä¸€ç¯‡ä¼šè®²è®²ä¼˜å…ˆçº§è°ƒåº¦ç›¸å…³çš„ä¸œè¥¿ã€‚

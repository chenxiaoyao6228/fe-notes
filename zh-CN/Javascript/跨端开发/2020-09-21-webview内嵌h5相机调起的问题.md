---
title: webviewå†…åµŒh5ç›¸æœºè°ƒèµ·çš„é—®é¢˜
tags:
- Uniapp
- javascript
date: 2020-09-08
permalink: 2020-09-21-html5-call-camera-on-android-webview

---

## å‰è¨€

æˆ‘ä»¬éœ€è¦å°†åŸºäºuniappå¼€å‘çš„H5é¡µé¢å†…åµŒåˆ°åˆä½œä¼™ä¼´çš„webviewä¸­ï¼Œä½†ç”±äºæµè§ˆå™¨çš„é™åˆ¶ï¼Œæ— æ³•å®ç°å›¾ç‰‡å¤šé€‰æ•ˆæœï¼Œå› æ­¤éœ€è¦æ±‚åŠ©åŸç”Ÿç«¯çš„èƒ½åŠ›ã€‚å…¶ä¸­éœ€è¦ç”¨åˆ°å®‰å“webviewä¸JSçš„äº¤äº’ç›¸å…³çš„çŸ¥è¯†ï¼Œç‰¹æ­¤æ€»ç»“ã€‚

## uniapp.chooseImageçš„åŸç†

æµè§ˆå™¨æ‹‰èµ·æ‰‹æœºç›¸æœºçš„ä¸¤ç§æ–¹å¼

* MediaDevices.getUserMedia()
* Inputæ ‡ç­¾

Uniappçš„H5ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§

### Input

```html
<input type="file" id="soundFile" accept="audio/*" capture="video">
<input type="file" id="videoFile" accept="video/*" capture="microphone">
<input type="file" id="imageFile" accept="image/*" capture="camera" multiple>
```

ä¸»è¦è®²è®²ä¸‹é¢ä¸¤ä¸ªå±æ€§

#### accept

* **å¤§å°å†™æ•æ„Ÿçš„æ–‡ä»¶æ‰©å±•å**ï¼Œå¦‚'doc','.pdf','jpg'
* æœ‰æ•ˆçš„MIMEç±»å‹ï¼Œæœ‰æ•ˆçš„MIMEç±»å‹,ğŸˆšï¸æ–‡ä»¶ç±»å‹åç¼€ã€‚

å¦‚ä¸Šé¢çš„`image/*`ä»»æ„ç±»å‹çš„å›¾ç‰‡

#### capture

ä½¿ç”¨ä½•ç§åª’ä½“æ¥ä¸Šä¼ å›¾ç‰‡, å¯¹åº”ä¸‰ä¸ªå€¼  `video`, `camera`, `microphone`

#### multiple

æ–‡ä»¶å¤šé€‰

éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæˆªè‡³2020å¹´12æœˆï¼Œç§»åŠ¨ç«¯æµè§ˆå™¨å¯¹HTMLçš„Input multipleå±æ€§çš„æ”¯æŒä¾ç„¶å¾ˆå¯æ€œã€‚
![input multipleå±æ€§çš„æ”¯æŒ](https://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/33F82C6799AF4CC190024E9432018241/67051)

è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œæƒ³è¦è¦æˆå›¾ç‰‡å¤šé€‰ï¼Œåªèƒ½æ±‚åŠ©åŸç”Ÿç«¯çš„èƒ½åŠ›

#### uni.chooseImageçš„æºç 

æ–‡ä»¶åœ¨`src/platforms/h5/service/api/media/choose-image.js`ä¸‹, ç†Ÿæ‚‰çš„æ“ä½œï¼šæ€åˆ›å»ºInputæ ‡ç­¾ï¼Œappendåˆ°bodyä¸‹ï¼Œç›‘å¬Inputçš„changeäº‹ä»¶ï¼Œç„¶åè°ƒç”¨clickæ–¹æ³•

```js
export function chooseImage ({
  count,
  // sizeType,
  sourceType
}, callbackId) {
  if (imageInput) {
    document.body.removeChild(imageInput)
    imageInput = null
  }

  imageInput = _createInput({
    count: count,
    sourceType: sourceType
  })
  document.body.appendChild(imageInput)

  imageInput.addEventListener('change', function (event) {
    const tempFiles = []
    const fileCount = event.target.files.length
    for (let i = 0; i < fileCount; i++) {
      const file = event.target.files[i]
      let filePath
      Object.defineProperty(file, 'path', {
        get () {
          filePath = filePath || fileToUrl(file)
          return filePath
        }
      })
      tempFiles.push(file)
    }
    const res = {
      errMsg: 'chooseImage:ok',
      get tempFilePaths () {
        return tempFiles.map(({ path }) => path)
      },
      tempFiles: tempFiles
    }
    invoke(callbackId, res)
  })

  imageInput.click()
}
```

```js
const _createInput = function (options) {
  const inputEl = document.createElement('input')
  inputEl.type = 'file'
  updateElementStyle(inputEl, {
    position: 'absolute',
    visibility: 'hidden',
    'z-index': -999,
    width: 0,
    height: 0,
    top: 0,
    left: 0
  })
  inputEl.accept = 'image/*'
  if (options.count > 1) {
    inputEl.multiple = 'multiple'
  }
  // ç»è¿‡æµ‹è¯•ï¼Œä»…èƒ½é™åˆ¶åªé€šè¿‡ç›¸æœºæ‹æ‘„ï¼Œä¸èƒ½é™åˆ¶åªå…è®¸ä»ç›¸å†Œé€‰æ‹©ã€‚
  if (options.sourceType.length === 1 && options.sourceType[0] === 'camera') {
    inputEl.capture = 'camera'
  }

  return inputEl
}
```

## ä»€ä¹ˆæ˜¯webview

ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…å®ç°åœ¨appå†…å±•ç¤ºç½‘é¡µå¹¶ä¸ç½‘é¡µäº¤äº’çš„éœ€æ±‚ï¼ŒAndroid SDKæä¾›äº†WebViewç»„ä»¶, Hybrid Appè¶Šæ¥è¶Šæµè¡Œçš„ä»Šå¤©ï¼Œäº†è§£webviewçš„ä½¿ç”¨å°±æ„ˆå‘é‡è¦

## Javascriptä¸Android Webviewäº¤äº’çš„å‡ ç§æ–¹å¼

ä»¥ä¸‹æ®µè½æ¥è‡ª[WebViewÂ·å¼€è½¦æŒ‡å—](https://jiandanxinli.github.io/2016-08-31.html)

### åˆ©ç”¨WebViewè°ƒç”¨ç½‘é¡µä¸Šçš„JavaScriptä»£ç 

åœ¨WebViewä¸­è°ƒç”¨Jsçš„åŸºæœ¬æ ¼å¼ä¸ºwebView.loadUrl("javascript:methodName(parameterValues)");

```js
function readyToGo() {
      alert("Hello")
  }

  function alertMessage(message) {
      alert(message)
  }

  function getYourCar(){
      return "Car";
  }
```

1. WebViewè°ƒç”¨JavaScriptæ— å‚æ— è¿”å›å€¼å‡½æ•°

```java
String call = "javascript:readyToGo()";
webView.loadUrl(call);
```

2. WebViewè°ƒç”¨JavScriptæœ‰å‚æ— è¿”å›å€¼å‡½æ•°

```java
String call = "javascript:alertMessage(\"" + "content" + "\")";
webView.loadUrl(call);
```

3. WebViewè°ƒç”¨JavaScriptæœ‰å‚æ•°æœ‰è¿”å›å€¼çš„å‡½æ•°

```java
@TargetApi(Build.VERSION_CODES.KITKAT)
private void evaluateJavaScript(WebView webView){
    webView.evaluateJavascript("getYourCar()", new ValueCallback<String>() {
        @Override
        public void onReceiveValue(String s) {
            Log.d("findCar",s);
        }
    });
}
```

### JavaScripté€šè¿‡WebViewè°ƒç”¨Javaä»£ç 

ä»API19å¼€å§‹ï¼ŒAndroidæä¾›äº†@JavascriptInterfaceå¯¹è±¡æ³¨è§£çš„æ–¹å¼æ¥å»ºç«‹èµ·Javascriptå¯¹è±¡å’ŒAndroidåŸç”Ÿå¯¹è±¡çš„ç»‘å®šï¼Œæä¾›ç»™JavScriptè°ƒç”¨çš„å‡½æ•°å¿…é¡»å¸¦æœ‰@JavascriptInterfaceã€‚

æ¼”ç¤ºä¸€ JavaScriptè°ƒç”¨Android Toastæ–¹æ³•

1. ç¼–å†™JavaåŸç”Ÿæ–¹æ³•å¹¶ç”¨ä½¿ç”¨@JavascriptInterfaceæ³¨è§£

```java
@JavascriptInterface
public void show(String s){
    Toast.makeText(getApplication(), s, Toast.LENGTH_SHORT).show();
}
```

2.æ³¨å†ŒJavaScriptInterface

```java
webView.addJavascriptInterface(this, "android");
addJavascriptInterfaceçš„ä½œç”¨æ˜¯æŠŠthisæ‰€ä»£è¡¨çš„ç±»æ˜ å°„ä¸ºJavaScriptä¸­çš„androidå¯¹è±¡ã€‚
```

3.ç¼–å†™JavaScriptä»£ç 

```js
function toastClick(){
    window.android.show("JavaScript called~!");
}
```

æ¼”ç¤ºäºŒ JavaScriptè°ƒç”¨æœ‰è¿”å›å€¼çš„Javaæ–¹æ³•

1.å®šä¹‰ä¸€ä¸ªå¸¦è¿”å›å€¼çš„Javaæ–¹æ³•ï¼Œå¹¶ä½¿ç”¨@JavaInterfaceï¼š

```java
@JavaInterface
public String getMessage(){
    return "Hello,boy~";
}
```

2.æ·»åŠ JavaScriptçš„æ˜ å°„

```java
webView.addJavaScriptInterface(this,"Android");
```

3.é€šè¿‡JavaScriptè°ƒç”¨Javaæ–¹æ³•

```js
function showHello(){
    var str=window.Android.getMessage();
    console.log(str);
}
```

## å‚è€ƒ

* [Input-MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file)

* [Input-accept-MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/accept)

* [WebViewÂ·å¼€è½¦æŒ‡å—](https://jiandanxinli.github.io/2016-08-31.html)

* [ç§»åŠ¨ç«¯H5æ‹‰èµ·æ‰‹æœºç›¸æœº](https://juejin.im/post/6844903859991609351)

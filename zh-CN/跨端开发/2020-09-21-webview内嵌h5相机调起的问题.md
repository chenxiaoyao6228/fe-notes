---
title: webview内嵌h5相机调起的问题
categories:
  - tech
tags:
  - Uniapp
  - javascript
date: 2020-09-08
permalink: 2020-09-21-html5-call-camera-on-android-webview
---

## 前言

我们需要将基于 uniapp 开发的 H5 页面内嵌到合作伙伴的 webview 中，但由于浏览器的限制，无法实现图片多选效果，因此需要求助原生端的能力。其中需要用到安卓 webview 与 JS 的交互相关的知识，特此总结。

## uniapp.chooseImage 的原理

浏览器拉起手机相机的两种方式

- MediaDevices.getUserMedia()
- Input 标签

Uniapp 的 H5 使用的是第二种

### Input

```html
<input type="file" id="soundFile" accept="audio/*" capture="video" />
<input type="file" id="videoFile" accept="video/*" capture="microphone" />
<input type="file" id="imageFile" accept="image/*" capture="camera" multiple />
```

主要讲讲下面两个属性

#### accept

- **大小写敏感的文件扩展名**，如'doc','.pdf','jpg'
- 有效的 MIME 类型，有效的 MIME 类型,🈚️ 文件类型后缀。

如上面的`image/*`任意类型的图片

#### capture

使用何种媒体来上传图片, 对应三个值 `video`, `camera`, `microphone`

#### multiple

文件多选

需要注意的是：截至 2020 年 12 月，移动端浏览器对 HTML 的 Input multiple 属性的支持依然很可怜。
![input multiple属性的支持](https://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/33F82C6799AF4CC190024E9432018241/67051)

这也就意味着，想要要成图片多选，只能求助原生端的能力

#### uni.chooseImage 的源码

文件在`src/platforms/h5/service/api/media/choose-image.js`下, 熟悉的操作：态创建 Input 标签，append 到 body 下，监听 Input 的 change 事件，然后调用 click 方法

```js
export function chooseImage(
  {
    count,
    // sizeType,
    sourceType,
  },
  callbackId
) {
  if (imageInput) {
    document.body.removeChild(imageInput);
    imageInput = null;
  }

  imageInput = _createInput({
    count: count,
    sourceType: sourceType,
  });
  document.body.appendChild(imageInput);

  imageInput.addEventListener("change", function (event) {
    const tempFiles = [];
    const fileCount = event.target.files.length;
    for (let i = 0; i < fileCount; i++) {
      const file = event.target.files[i];
      let filePath;
      Object.defineProperty(file, "path", {
        get() {
          filePath = filePath || fileToUrl(file);
          return filePath;
        },
      });
      tempFiles.push(file);
    }
    const res = {
      errMsg: "chooseImage:ok",
      get tempFilePaths() {
        return tempFiles.map(({ path }) => path);
      },
      tempFiles: tempFiles,
    };
    invoke(callbackId, res);
  });

  imageInput.click();
}
```

```js
const _createInput = function (options) {
  const inputEl = document.createElement("input");
  inputEl.type = "file";
  updateElementStyle(inputEl, {
    position: "absolute",
    visibility: "hidden",
    "z-index": -999,
    width: 0,
    height: 0,
    top: 0,
    left: 0,
  });
  inputEl.accept = "image/*";
  if (options.count > 1) {
    inputEl.multiple = "multiple";
  }
  // 经过测试，仅能限制只通过相机拍摄，不能限制只允许从相册选择。
  if (options.sourceType.length === 1 && options.sourceType[0] === "camera") {
    inputEl.capture = "camera";
  }

  return inputEl;
};
```

## 什么是 webview

为了方便开发者实现在 app 内展示网页并与网页交互的需求，Android SDK 提供了 WebView 组件, Hybrid App 越来越流行的今天，了解 webview 的使用就愈发重要

## Javascript 与 Android Webview 交互的几种方式

以下段落来自[WebView·开车指南](https://jiandanxinli.github.io/2016-08-31.html)

### 利用 WebView 调用网页上的 JavaScript 代码

在 WebView 中调用 Js 的基本格式为 webView.loadUrl("javascript:methodName(parameterValues)");

```js
function readyToGo() {
  alert("Hello");
}

function alertMessage(message) {
  alert(message);
}

function getYourCar() {
  return "Car";
}
```

1. WebView 调用 JavaScript 无参无返回值函数

```java
String call = "javascript:readyToGo()";
webView.loadUrl(call);
```

2. WebView 调用 JavScript 有参无返回值函数

```java
String call = "javascript:alertMessage(\"" + "content" + "\")";
webView.loadUrl(call);
```

3. WebView 调用 JavaScript 有参数有返回值的函数

```java
@TargetApi(Build.VERSION_CODES.KITKAT)
private void evaluateJavaScript(WebView webView){
    webView.evaluateJavascript("getYourCar()", new ValueCallback<String>() {
        @Override
        public void onReceiveValue(String s) {
            Log.d("findCar",s);
        }
    });
}
```

### JavaScript 通过 WebView 调用 Java 代码

从 API19 开始，Android 提供了@JavascriptInterface 对象注解的方式来建立起 Javascript 对象和 Android 原生对象的绑定，提供给 JavScript 调用的函数必须带有@JavascriptInterface。

演示一 JavaScript 调用 Android Toast 方法

1. 编写 Java 原生方法并用使用@JavascriptInterface 注解

```java
@JavascriptInterface
public void show(String s){
    Toast.makeText(getApplication(), s, Toast.LENGTH_SHORT).show();
}
```

2.注册 JavaScriptInterface

```java
webView.addJavascriptInterface(this, "android");
addJavascriptInterface的作用是把this所代表的类映射为JavaScript中的android对象。
```

3.编写 JavaScript 代码

```js
function toastClick() {
  window.android.show("JavaScript called~!");
}
```

演示二 JavaScript 调用有返回值的 Java 方法

1.定义一个带返回值的 Java 方法，并使用@JavaInterface：

```java
@JavaInterface
public String getMessage(){
    return "Hello,boy~";
}
```

2.添加 JavaScript 的映射

```java
webView.addJavaScriptInterface(this,"Android");
```

3.通过 JavaScript 调用 Java 方法

```js
function showHello() {
  var str = window.Android.getMessage();
  console.log(str);
}
```

## 参考

- [Input-MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file)

- [Input-accept-MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/accept)

- [WebView·开车指南](https://jiandanxinli.github.io/2016-08-31.html)

- [移动端 H5 拉起手机相机](https://juejin.im/post/6844903859991609351)

---
title: webviewå†…åµŒh5ç›¸æœºè°ƒèµ·çš„é—®é¢˜
categories:
  - tech
tags:
  - Uniapp
  - javascript
date: 2020-09-08
permalink: 2020-09-21-html5-call-camera-on-android-webview
---

## å‰è¨€

æˆ‘ä»¬éœ€è¦å°†åŸºäº uniapp å¼€å‘çš„ H5 é¡µé¢å†…åµŒåˆ°åˆä½œä¼™ä¼´çš„ webview ä¸­ï¼Œä½†ç”±äºæµè§ˆå™¨çš„é™åˆ¶ï¼Œæ— æ³•å®ç°å›¾ç‰‡å¤šé€‰æ•ˆæœï¼Œå› æ­¤éœ€è¦æ±‚åŠ©åŸç”Ÿç«¯çš„èƒ½åŠ›ã€‚å…¶ä¸­éœ€è¦ç”¨åˆ°å®‰å“ webview ä¸ JS çš„äº¤äº’ç›¸å…³çš„çŸ¥è¯†ï¼Œç‰¹æ­¤æ€»ç»“ã€‚

## uniapp.chooseImage çš„åŸç†

æµè§ˆå™¨æ‹‰èµ·æ‰‹æœºç›¸æœºçš„ä¸¤ç§æ–¹å¼

- MediaDevices.getUserMedia()
- Input æ ‡ç­¾

Uniapp çš„ H5 ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§

### Input

```html
<input type="file" id="soundFile" accept="audio/*" capture="video" />
<input type="file" id="videoFile" accept="video/*" capture="microphone" />
<input type="file" id="imageFile" accept="image/*" capture="camera" multiple />
```

ä¸»è¦è®²è®²ä¸‹é¢ä¸¤ä¸ªå±æ€§

#### accept

- **å¤§å°å†™æ•æ„Ÿçš„æ–‡ä»¶æ‰©å±•å**ï¼Œå¦‚'doc','.pdf','jpg'
- æœ‰æ•ˆçš„ MIME ç±»å‹ï¼Œæœ‰æ•ˆçš„ MIME ç±»å‹,ğŸˆšï¸ æ–‡ä»¶ç±»å‹åç¼€ã€‚

å¦‚ä¸Šé¢çš„`image/*`ä»»æ„ç±»å‹çš„å›¾ç‰‡

#### capture

ä½¿ç”¨ä½•ç§åª’ä½“æ¥ä¸Šä¼ å›¾ç‰‡, å¯¹åº”ä¸‰ä¸ªå€¼ `video`, `camera`, `microphone`

#### multiple

æ–‡ä»¶å¤šé€‰

éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæˆªè‡³ 2020 å¹´ 12 æœˆï¼Œç§»åŠ¨ç«¯æµè§ˆå™¨å¯¹ HTML çš„ Input multiple å±æ€§çš„æ”¯æŒä¾ç„¶å¾ˆå¯æ€œã€‚
![input multipleå±æ€§çš„æ”¯æŒ](https://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/33F82C6799AF4CC190024E9432018241/67051)

è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œæƒ³è¦è¦æˆå›¾ç‰‡å¤šé€‰ï¼Œåªèƒ½æ±‚åŠ©åŸç”Ÿç«¯çš„èƒ½åŠ›

#### uni.chooseImage çš„æºç 

æ–‡ä»¶åœ¨`src/platforms/h5/service/api/media/choose-image.js`ä¸‹, ç†Ÿæ‚‰çš„æ“ä½œï¼šæ€åˆ›å»º Input æ ‡ç­¾ï¼Œappend åˆ° body ä¸‹ï¼Œç›‘å¬ Input çš„ change äº‹ä»¶ï¼Œç„¶åè°ƒç”¨ click æ–¹æ³•

```js
export function chooseImage(
  {
    count,
    // sizeType,
    sourceType,
  },
  callbackId
) {
  if (imageInput) {
    document.body.removeChild(imageInput);
    imageInput = null;
  }

  imageInput = _createInput({
    count: count,
    sourceType: sourceType,
  });
  document.body.appendChild(imageInput);

  imageInput.addEventListener("change", function (event) {
    const tempFiles = [];
    const fileCount = event.target.files.length;
    for (let i = 0; i < fileCount; i++) {
      const file = event.target.files[i];
      let filePath;
      Object.defineProperty(file, "path", {
        get() {
          filePath = filePath || fileToUrl(file);
          return filePath;
        },
      });
      tempFiles.push(file);
    }
    const res = {
      errMsg: "chooseImage:ok",
      get tempFilePaths() {
        return tempFiles.map(({ path }) => path);
      },
      tempFiles: tempFiles,
    };
    invoke(callbackId, res);
  });

  imageInput.click();
}
```

```js
const _createInput = function (options) {
  const inputEl = document.createElement("input");
  inputEl.type = "file";
  updateElementStyle(inputEl, {
    position: "absolute",
    visibility: "hidden",
    "z-index": -999,
    width: 0,
    height: 0,
    top: 0,
    left: 0,
  });
  inputEl.accept = "image/*";
  if (options.count > 1) {
    inputEl.multiple = "multiple";
  }
  // ç»è¿‡æµ‹è¯•ï¼Œä»…èƒ½é™åˆ¶åªé€šè¿‡ç›¸æœºæ‹æ‘„ï¼Œä¸èƒ½é™åˆ¶åªå…è®¸ä»ç›¸å†Œé€‰æ‹©ã€‚
  if (options.sourceType.length === 1 && options.sourceType[0] === "camera") {
    inputEl.capture = "camera";
  }

  return inputEl;
};
```

## ä»€ä¹ˆæ˜¯ webview

ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…å®ç°åœ¨ app å†…å±•ç¤ºç½‘é¡µå¹¶ä¸ç½‘é¡µäº¤äº’çš„éœ€æ±‚ï¼ŒAndroid SDK æä¾›äº† WebView ç»„ä»¶, Hybrid App è¶Šæ¥è¶Šæµè¡Œçš„ä»Šå¤©ï¼Œäº†è§£ webview çš„ä½¿ç”¨å°±æ„ˆå‘é‡è¦

## Javascript ä¸ Android Webview äº¤äº’çš„å‡ ç§æ–¹å¼

ä»¥ä¸‹æ®µè½æ¥è‡ª[WebViewÂ·å¼€è½¦æŒ‡å—](https://jiandanxinli.github.io/2016-08-31.html)

### åˆ©ç”¨ WebView è°ƒç”¨ç½‘é¡µä¸Šçš„ JavaScript ä»£ç 

åœ¨ WebView ä¸­è°ƒç”¨ Js çš„åŸºæœ¬æ ¼å¼ä¸º webView.loadUrl("javascript:methodName(parameterValues)");

```js
function readyToGo() {
  alert("Hello");
}

function alertMessage(message) {
  alert(message);
}

function getYourCar() {
  return "Car";
}
```

1. WebView è°ƒç”¨ JavaScript æ— å‚æ— è¿”å›å€¼å‡½æ•°

```java
String call = "javascript:readyToGo()";
webView.loadUrl(call);
```

2. WebView è°ƒç”¨ JavScript æœ‰å‚æ— è¿”å›å€¼å‡½æ•°

```java
String call = "javascript:alertMessage(\"" + "content" + "\")";
webView.loadUrl(call);
```

3. WebView è°ƒç”¨ JavaScript æœ‰å‚æ•°æœ‰è¿”å›å€¼çš„å‡½æ•°

```java
@TargetApi(Build.VERSION_CODES.KITKAT)
private void evaluateJavaScript(WebView webView){
    webView.evaluateJavascript("getYourCar()", new ValueCallback<String>() {
        @Override
        public void onReceiveValue(String s) {
            Log.d("findCar",s);
        }
    });
}
```

### JavaScript é€šè¿‡ WebView è°ƒç”¨ Java ä»£ç 

ä» API19 å¼€å§‹ï¼ŒAndroid æä¾›äº†@JavascriptInterface å¯¹è±¡æ³¨è§£çš„æ–¹å¼æ¥å»ºç«‹èµ· Javascript å¯¹è±¡å’Œ Android åŸç”Ÿå¯¹è±¡çš„ç»‘å®šï¼Œæä¾›ç»™ JavScript è°ƒç”¨çš„å‡½æ•°å¿…é¡»å¸¦æœ‰@JavascriptInterfaceã€‚

æ¼”ç¤ºä¸€ JavaScript è°ƒç”¨ Android Toast æ–¹æ³•

1. ç¼–å†™ Java åŸç”Ÿæ–¹æ³•å¹¶ç”¨ä½¿ç”¨@JavascriptInterface æ³¨è§£

```java
@JavascriptInterface
public void show(String s){
    Toast.makeText(getApplication(), s, Toast.LENGTH_SHORT).show();
}
```

2.æ³¨å†Œ JavaScriptInterface

```java
webView.addJavascriptInterface(this, "android");
addJavascriptInterfaceçš„ä½œç”¨æ˜¯æŠŠthisæ‰€ä»£è¡¨çš„ç±»æ˜ å°„ä¸ºJavaScriptä¸­çš„androidå¯¹è±¡ã€‚
```

3.ç¼–å†™ JavaScript ä»£ç 

```js
function toastClick() {
  window.android.show("JavaScript called~!");
}
```

æ¼”ç¤ºäºŒ JavaScript è°ƒç”¨æœ‰è¿”å›å€¼çš„ Java æ–¹æ³•

1.å®šä¹‰ä¸€ä¸ªå¸¦è¿”å›å€¼çš„ Java æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨@JavaInterfaceï¼š

```java
@JavaInterface
public String getMessage(){
    return "Hello,boy~";
}
```

2.æ·»åŠ  JavaScript çš„æ˜ å°„

```java
webView.addJavaScriptInterface(this,"Android");
```

3.é€šè¿‡ JavaScript è°ƒç”¨ Java æ–¹æ³•

```js
function showHello() {
  var str = window.Android.getMessage();
  console.log(str);
}
```

## å‚è€ƒ

- [Input-MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file)

- [Input-accept-MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/accept)

- [WebViewÂ·å¼€è½¦æŒ‡å—](https://jiandanxinli.github.io/2016-08-31.html)

- [ç§»åŠ¨ç«¯ H5 æ‹‰èµ·æ‰‹æœºç›¸æœº](https://juejin.im/post/6844903859991609351)

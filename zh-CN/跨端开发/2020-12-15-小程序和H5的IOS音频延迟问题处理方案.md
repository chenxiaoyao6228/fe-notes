---
title: uniapp小程序和H5的IOS音频延迟问题处理方案
categories:
  - tech
tags:
  - javascript
date: 2020-12-15
permalink:  2020-12-15-请设置英文名
---

## 问题

我们的客户端添加了音频留言功能，但是在IOS端会出现音频延迟的情况(安卓秒加载)，经测试，在网络不是很好的情况下可能出现将近10s的加载，这是不可接受的。

首先排除了服务器响应慢的问题，因为安卓端秒加载(不能石锤了，好气哦)

一开始以为是uniapp的bug, 去论坛上搜了一波，按照官方提示升级了，却仍然出现，后写了个小程序demo页，定位到小程序也依然存在问题。

此外，不同的IOS版本，加载速度也不同，音频长度也是影响因素。

最后定位到是ios系统的限制，在音频方面包括：

1. 禁止预加载行为， 在HTML5上audio的preload属性是不生效的， 据说是为了节省用户流量。
2. 禁止自动触发音频播放，避免一些场合给用户带来困扰。
3. 。。。

## 方案

### 尝试1

小程序的InnerAudioContext对象自带了一些事件

```
onWait: 监听音频加载中事件。当音频因为数据不足，需要停下来加载时会触发

onCanPlay: 监听音频进入可以播放状态的事件。但不保证后面可以流畅播放

onPlay: 播放。

onPause: 暂停。暂停后的音频再播放会从暂停处开始播放

onStop: 停止。停止后的音频再播放会从头开始播放。

onError: 异常时触发

onEnded: 监听音频自然播放至结束的事件
```

一开始的想法是监听onWait和onCanPlay或者onPlay事件，添加一个音频的loading状态，这是最次的方法，但是经过试验，是不可行的, 如图

![innerAudioContext事件](http://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/063941ADD43D45668E8AC902926253C6/67088)

而且模拟器,安卓,IOS的情况各不相同, 如一段长音频, 某次测试IOS的情况是这样的

```js
onPlay => 用户点击触发play()方法
onWaiting
onPause
onWaiting
onPause
onWaiting
onPlay
onPause
```

* 且安卓的onPlay事件在音频播放之前就触发, 而IOS在音频播放之后才触发

* onCanPlay事件不一定会触发，也有可能onWait->onPlay一步到位
* 非用户操作微信小程序自己也会触发onPlay和onPause

总之就是, **边加载边播放的方式不不靠谱的**

### 尝试2

上面的尝试不行, 自然想到预先加载的方式, 等加载完,把文件保存在本地，下面是简化的代码

```javascript
let that = this
familyMemos.nodes.forEach((item) => {
  if (item.memoContentType === 'audio') {
      uni.downloadFile({
        url: item.audio.url
      }).then(([err, res]) => {
        if(err){
          // handle error
        }
        if (res && res.statusCode === 200) {
            // #ifdef MP-WEIXIN
            uni.saveFile({ tempFilePath: res.tempFilePath }).then(([err, res]) => {
              if (err) {
                // handle error
              }
              if (res) {
                // 小程序对文件地址有限制，且tempFilePath在各个端表现不同
                that.$set(that.memos.nodes[index].audio, 'url', res.savedFilePath)
                that.$set(that.memos.nodes[index].audio, 'state', 'loaded')
              }
            })
            // #endif
            // #ifdef H5
            that.$set(that.memos.nodes[index].audio, 'url', res.tempFilePath) //
            that.$set(that.memos.nodes[index].audio, 'state', 'loaded')
            // #endif
        }
    }
  }
})
```

wx.downloadFile有限制，需要注意看文档！

## 额外发现

问题解决了，但是在搜索的过程中也发现了些记得记录的东西。

### Web Audio API

继audio标签后的给更为强大的操作音频的方式. 看了下浏览器兼容性还不错

![](http://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/WEBRESOURCE1c4a27785375a4ff60f62a8a3bf17084/67090)

### Create.js

一个强大的预加载库, 包括音频,视频,图片加载等功能, [地址](https://www.createjs.com/)

![](http://note.youdao.com/yws/public/resource/1f466420b40e359c829bda0a8716b54a/xmlnote/D7FAD6EFA76244CBA4A16935E54278C0/67092)

音频使用的是Web Audio API, 浏览器不支持的情况下回fallback回audio标签

### howler.js

也是是个音频预加载库

## 参考

[张鑫旭：HTML audio基础API完全使用指南:](<https://www.zhangxinxu.com/wordpress/2019/07/html-audio-api-guide/>)

[Web_Audio_API](<https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API>)

[IOS录音末尾被截断 / 录音API 在IOS和Android的不同表现及解决方法
](https://developers.weixin.qq.com/community/develop/article/doc/000602512801106806ca3046058c13)

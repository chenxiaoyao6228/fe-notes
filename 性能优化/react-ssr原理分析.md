## å‰è¨€

æœ¬æ–‡å°†ä»‹ç» React SSR ç›¸å…³çš„çŸ¥è¯†

## SSR çš„ä¼˜ç¼ºç‚¹åŠé€‚ç”¨åœºæ™¯

### SSR çš„ä¼˜åŠ¿

ä¸ CSR(client-side-rendering)ç›¸æ¯”ï¼Œ SSR å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

#### æ€§èƒ½

- ç½‘ç»œé“¾è·¯ï¼šçœå»äº†å®¢æˆ·ç«¯äºŒæ¬¡è¯·æ±‚æ•°æ®çš„ç½‘ç»œä¼ è¾“å¼€é”€ï¼ŒæœåŠ¡ç«¯çš„ç½‘ç»œç¯å¢ƒè¦ä¼˜äºå®¢æˆ·ç«¯ï¼Œå†…éƒ¨æœåŠ¡å™¨ä¹‹é—´é€šä¿¡è·¯å¾„ä¹Ÿæ›´çŸ­

- å†…å®¹å‘ˆç°ï¼š é¦–å±åŠ è½½æ—¶é—´ï¼ˆFCPï¼‰æ›´å¿«ï¼Œæµè§ˆå™¨å†…å®¹è§£æä¼˜åŒ–æœºåˆ¶èƒ½å¤Ÿå‘æŒ¥ä½œç”¨

#### å¯è®¿é—®æ€§

ç›¸æ¯” CSR çš„ç©ºå£³é¦–é¡µè€Œè¨€ï¼ŒSSR é¦–å±çš„é¡µé¢è¦ä¸°å¯Œå¾—å¤š.
![](https://cdn.jsdelivr.net/gh/chenxiaoyao6228/cloudimg@main/2023/ssr-juejin.png)

### SSR çš„ç¼ºç‚¹

- æ”¹é€ æˆæœ¬å¤§ï¼šå­˜é‡çš„ CSR ä»£ç å®ç°æ”¹é€ å›°éš¾
- æœåŠ¡çš„ç¨³å®šæ€§å’Œæ€§èƒ½è¦æ±‚ä»¥åŠæœåŠ¡å™¨çš„æˆæœ¬
- é…å¥—è®¾æ–½çš„å»ºè®¾

### SSR çš„é€‚ç”¨åœºæ™¯

å†…å®¹å¯†é›†å‹é¡µé¢ï¼Œå¦‚ç¨€åœŸæ˜é‡‘è¿™ç±»é—¨æˆ·ç½‘ç«™ï¼Œä»¥åŠå…¬å¸å®˜ç½‘ã€‚

## SSR æ¶‰åŠçš„æŠ€æœ¯ç‚¹

### é¦–é¡µè¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚ä½•å°†ç»„ä»¶è½¬åŒ–ä¸º HTML

- å¦‚ä½•åœ¨ server ç«¯è·‘ jsx => è·‘ webpack å°†ç”Ÿæˆ bundle, ç„¶åé‡å¯ server, (nodemon è‡ªåŠ¨é‡å¯)
- å°† JS ç»„ä»¶è½¬åŒ–ä¸º html => ReactDOM.renderToString()

### å¦‚ä½•æ ¹æ®ä¸åŒçš„ç”¨æˆ·è·¯ç”±è¿›å…¥

åœ¨ node å±‚åŠ«æŒ`req.path`, å†æ ¹æ® act-router-config åŒ¹é…å‡ºå¯¹åº”çš„ç»„ä»¶ï¼Œå†è¿›è¡Œæ¸²æŸ“

### server ç«¯å’Œ client ç«¯æœ‰ä¸¤ä¸ªå®Œå…¨ä¸ä¸€æ ·çš„ storeï¼Œ è¯¥å¦‚ä½•å¤„ç†

- server æ³¨å…¥ JSON æ•°æ®
- client åˆå§‹åŒ– store çš„æ—¶å€™ä½¿ç”¨è¯¥ store

```js
const store = createStore(
  reducers,
  window.INITIAL_STATE,
  applyMiddleware(thunk.withExtraArgument(axiosInstance))
);
```

> ğŸ˜ƒ Update: è¿™ç‚¹å…¶å®å¯ä»¥å€Ÿé‰´ï¼Œå¦‚æœé¡¹ç›®ä¸­æœ‰ node ä½œä¸º BFF å±‚çš„è¯ï¼Œ å¯ä»¥æŠŠç”¨æˆ·ç™»å½•ç›¸å…³çš„è¯·æ±‚åœ¨ node å±‚å¤„ç†ï¼Œæ³¨å…¥åˆ° html, å†è¿›è¡Œè„±æ°´

> æ—§æ¨¡å¼:
> å®¢æˆ·ç«¯é¡µé¢çš„å±•ç¤ºæµç¨‹ä¸ºï¼š`è·å– index.html => è·å– bundle.js => æ‰§è¡Œ bundle.js => å‘èµ· checkToken è¯·æ±‚ => å‘èµ· getUserInfo è¯·æ±‚ => æ¸²æŸ“é¡µé¢å…ƒç´ `ã€‚ç”¨æˆ·å·²ç™»å½•çš„æƒ…å†µä¸‹ï¼Œé¡µé¢è‡³å°‘éœ€è¦ç­‰ 4RTT æ—¶é—´åæ‰èƒ½è¿›è¡Œæ­£å¸¸çš„é¡µé¢æ¸²æŸ“ï¼Œè€Œæœªç™»å½•çš„æƒ…å†µä¸‹ï¼Œä¹Ÿéœ€è¦ 3RTT æ—¶é—´åæ‰èƒ½è·³è½¬åˆ°ç™»å½•é¡µã€‚

> æ–°æ¨¡å¼:
> ä¸ºäº†å‡å°‘é¡µé¢çš„ RTTï¼Œè®©é¡µé¢å°½å¿«è¿›å…¥æ¸²æŸ“çŠ¶æ€ï¼Œæ‰€ä»¥åœ¨ç”¨æˆ·ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œå°±å°è¯•æŠŠç”¨æˆ·ä¿¡æ¯æ³¨å…¥åˆ°é¡µé¢ä¸­ï¼Œæ­¤è¿‡ç¨‹ç§°ä¸ºæ³¨æ°´ã€‚åœ¨é¡µé¢é¦–æ¬¡ dom è§£ææ—¶ï¼Œå°†æ³¨å…¥çš„ä¿¡æ¯æŒ‚è½½åˆ° window å¯¹è±¡ä¸Šï¼Œåœ¨ umi.js æ‰§è¡Œæ—¶å°† window ä¸Šçš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œå¹¶é”€æ¯ window ä¸Šçš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ­¤è¿‡ç¨‹ç§°ä¸ºè„±æ°´ã€‚
> ç»è¿‡ç”¨æˆ·ä¿¡æ¯çš„æ³¨æ°´ä¸è„±æ°´ï¼Œé¡µé¢çš„æ¸²æŸ“æµç¨‹å˜ä¸ºï¼š`è·å– index.html => => æ‰§è¡Œ bundle.js => æ¸²æŸ“é¡µé¢å…ƒç´ `ã€‚ç”¨æˆ·å·²ç™»å½•çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦ 2RTT å³å¯æ­£å¸¸æ¸²æŸ“é¡µé¢ï¼Œç”¨æˆ·æœªç™»å½•çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦ 1RTT å³å¯è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚

### å¦‚ä½•é˜²æ­¢ XSS æ”»å‡»

ä¸èƒ½ç®€å•åœ°ç”¨ JSON.stringify

```js
window.INITIAL_STATE = ${serialize(store.getState())}
```

### å¼‚å¸¸å¤„ç†

- åœ¨ SSR: api å‡ºé”™ç­‰å¼‚å¸¸çš„æ—¶å€™ï¼Œå¦‚ä½•ä¿è¯ç”¨æˆ·ä½“éªŒï¼Ÿ

## å‚è€ƒ

- [SSR - server side rendering with react and redux](https://www.bilibili.com/video/BV194411t7aq)
- [SSR çš„åˆ©ä¸å¼Š](http://www.ayqy.net/blog/ssr-pros-and-cons/)
